@page
@{
    ViewData["Title"] = "My Price Alerts";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="text-center mb-4">
    <h1 class="display-4">My Price Alerts</h1>
    <div id="lastRefresh" class="badge bg-info" style="display:none;"></div>
</div>

@if (!User.Identity?.IsAuthenticated ?? true)
{
    <div class="alert alert-info" role="alert">
        <p>Please <a href="/Identity/Account/Login" class="alert-link">log in</a> to view your alerts.</p>
    </div>
}
else
{
    <div class="container-fluid p-3 mb-4">
        <div id="alertsContainer" class="row g-3">
            <!-- Alerts will be loaded here -->
        </div>
    </div>
}

<script>
    console.log('Alerts page script loaded');

    function loadAlerts() {
        console.log('loadAlerts called');
        fetch('/api/alert')
            .then(response => {
                console.log('API response status:', response.status);
                if (!response.ok) throw new Error('Failed to load alerts');
                return response.json();
            })
            .then(allAlerts => {
                console.log('Alerts received:', allAlerts);
                const activeAlerts = allAlerts.filter(a => a.isActive);
                console.log('Active alerts:', activeAlerts);
                displayAlerts(activeAlerts);
                
                const now = new Date().toLocaleTimeString();
                const refreshEl = document.getElementById('lastRefresh');
                if (refreshEl) {
                    refreshEl.textContent = `Last refresh: ${now}`;
                    refreshEl.style.display = 'inline-block';
                }
            })
            .catch(error => console.error('Error loading alerts:', error));
    }

    function displayAlerts(alerts) {
        const container = document.getElementById('alertsContainer');
        console.log('displayAlerts called with', alerts.length, 'alerts');
        
        if (!container) {
            console.error('Alert container not found!');
            return;
        }
        
        if (alerts.length === 0) {
            console.log('No alerts found');
            container.innerHTML = '<div class="col-12"><div class="alert alert-info"><p class="mb-0">No active alerts. Search for items on the home page to create alerts.</p></div></div>';
            return;
        }

        console.log('Building cards for', alerts.length, 'alerts');
        container.innerHTML = '';
        
        alerts.forEach((alert, index) => {
            console.log(`Building card for alert ${index}:`, alert.itemName);
            const currentPrice = alert.currentPrice ? `${alert.currentPrice}p` : 'Checking...';
            const cardHtml = `
                <div class="col-md-6 col-lg-4">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title">${alert.itemName}</h5>
                            <p class="mb-2">
                                <small class="text-muted">Alert Price:</small><br>
                                <strong>${alert.alertPrice}p</strong>
                            </p>
                            <p class="mb-3">
                                <small class="text-muted">Current Price:</small><br>
                                <strong>${currentPrice}</strong>
                            </p>
                        </div>
                        <div class="card-footer bg-transparent">
                            <a href="/?search=${encodeURIComponent(alert.itemName)}" class="btn btn-sm btn-outline-primary me-2">
                                <i class="fas fa-eye"></i> View
                            </a>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteAlert(${alert.id})">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                </div>
            `;
            container.innerHTML += cardHtml;
        });
    }

    function deleteAlert(id) {
        if (!confirm('Are you sure you want to remove this alert?')) return;

        fetch(`/api/alert/${id}`, { method: 'DELETE' })
            .then(response => {
                if (!response.ok) throw new Error('Failed to delete alert');
                console.log('Alert deleted');
                loadAlerts();
            })
            .catch(error => {
                console.error('Error deleting alert:', error);
                alert('Failed to delete alert');
            });
    }

    // Load alerts when page loads
    console.log('Setting up page load listener');
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOMContentLoaded event fired');
            loadAlerts();
        });
    } else {
        console.log('Page already loaded, calling loadAlerts immediately');
        loadAlerts();
    }

    // Refresh every 30 seconds
    setInterval(loadAlerts, 30000);
    console.log('Interval set for 30 second refresh');
</script>


